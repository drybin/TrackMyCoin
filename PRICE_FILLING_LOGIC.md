# Логика заполнения пропущенных цен

## Как это работает

Программа автоматически заполняет пропущенные цены в Google Sheets, используя CoinGecko API.

## Временная логика

### Часовой пояс
Все даты и время в таблице должны быть в **GMT+7**.

### Алгоритм проверки

Для каждой записи:

1. Парсим дату и время из полей `Date` и `Time`
2. Для каждого поля с ценой вычисляем целевое время:
   - `Price10Min` = время записи + 10 минут
   - `Price30Min` = время записи + 30 минут
   - `Price1Hour` = время записи + 1 час
   - и так далее...

3. Сравниваем целевое время с текущим временем:
   - **Если целевое время уже прошло И поле пустое** → получаем цену с CoinGecko
   - **Если целевое время еще не наступило** → пропускаем (рано получать цену)
   - **Если поле уже заполнено** → пропускаем (цена уже есть)

## Примеры

### Пример 1: Свежая запись

**Запись в таблице:**
- Дата: 29.12.2025
- Время: 14:00:00
- Монета: BTC
- Все цены пустые

**Текущее время:** 29.12.2025 14:05:00 (GMT+7)

**Что произойдет:**
- ✅ `BybitPrice` - заполнится текущей ценой
- ❌ `Price10Min` (нужна на 14:10) - еще не наступило
- ❌ `Price30Min` (нужна на 14:30) - еще не наступило
- ❌ Все остальные - еще не наступило

### Пример 2: Запись через 15 минут

**Запись в таблице:**
- Дата: 29.12.2025
- Время: 14:00:00
- Монета: ETH
- Все цены пустые

**Текущее время:** 29.12.2025 14:15:00 (GMT+7)

**Что произойдет:**
- ✅ `BybitPrice` - заполнится
- ✅ `Price10Min` (14:10) - время прошло, заполнится
- ❌ `Price30Min` (14:30) - еще не наступило
- ❌ `Price1Hour` (15:00) - еще не наступило
- ❌ Остальные - еще не наступило

### Пример 3: Старая запись

**Запись в таблице:**
- Дата: 25.12.2025
- Время: 10:00:00
- Монета: SOL
- Все цены пустые

**Текущее время:** 29.12.2025 18:00:00 (GMT+7)

**Что произойдет:**
- ✅ `BybitPrice` - заполнится
- ✅ `Price10Min` - заполнится
- ✅ `Price30Min` - заполнится
- ✅ `Price1Hour` - заполнится
- ✅ `Price2Hours` - заполнится
- ✅ `Price6Hours` - заполнится
- ✅ `Price12Hours` - заполнится
- ✅ `Price24Hours` - заполнится
- ✅ `Price3Days` (прошло 4 дня) - заполнится
- ❌ `Price5Days` (нужно 5 дней) - еще не прошло
- ❌ `Price7Days` - еще не прошло
- ❌ `Price1Month` - еще не прошло

### Пример 4: Частично заполненная запись

**Запись в таблице:**
- Дата: 28.12.2025
- Время: 09:00:00
- Монета: BNB
- BybitPrice: 450.00 (уже заполнена)
- Price10Min: 451.00 (уже заполнена)
- Price30Min: пусто
- Price1Hour: пусто

**Текущее время:** 29.12.2025 12:00:00 (GMT+7)

**Что произойдет:**
- ❌ `BybitPrice` - уже есть, пропускаем
- ❌ `Price10Min` - уже есть, пропускаем
- ✅ `Price30Min` (28.12 09:30) - время прошло, заполнится
- ✅ `Price1Hour` (28.12 10:00) - время прошло, заполнится
- ✅ `Price2Hours` и далее - все прошедшие интервалы заполнятся

## Автоматическое обновление Google Sheets

После заполнения всех пропущенных цен программа **автоматически записывает** обновленные данные обратно в Google Sheets.

### Что обновляется:
- ✅ Все строки с данными (начиная со строки 2)
- ✅ Все 18 колонок (от Date до Price1Month)
- ✅ Заполненные цены записываются как числа
- ✅ Пустые цены остаются пустыми

### Что НЕ обновляется:
- ❌ Заголовки (первая строка) остаются нетронутыми
- ❌ Форматирование таблицы сохраняется
- ❌ Формулы и комментарии не затрагиваются

### Процесс обновления:

```
======================
Updating Google Sheets with new data...
======================
Sheet name: Лист1
Writing 10 records to range: Лист1!A2:R11
✅ Successfully updated Google Sheets!
Updated 10 rows in spreadsheet
======================

✅ Process completed successfully!
```

## Запуск вручную

Вы можете запускать команду `process` периодически (например, каждый час), и она будет автоматически:
1. Читать данные из Google Sheets
2. Заполнять пропущенные цены (только те, для которых наступило время)
3. Записывать обновленные данные обратно в таблицу

```bash
# Запуск вручную
go run ./cmd/cli/... process

# Или через cron (каждый час)
0 * * * * cd /path/to/project && go run ./cmd/cli/... process
```

## Ограничения CoinGecko API

**Бесплатный тариф:**
- 10-30 запросов в минуту
- Задержка между запросами ~1-2 секунды

Программа делает по 1 запросу на каждое пустое поле, поэтому:
- Если у вас 10 записей с 5 пустыми полями каждая = 50 запросов
- Это займет примерно 1-2 минуты

## Точность цен

⚠️ **Важно:** CoinGecko возвращает **текущую** цену на момент запроса, а не историческую цену на конкретный момент времени.

Это означает:
- Если запись была создана вчера в 10:00, а вы запускаете программу сегодня
- Программа получит **сегодняшнюю** цену, а не вчерашнюю

Для получения исторических цен потребуется:
- Платный тариф CoinGecko API
- Или другой сервис с историческими данными

